var ip;let c={},h=0,w=0,Ctx={},CtxG={},dataY=[],dataX=[],datal1=[],datal2=[],datal3=[],dataGas=[],dataGasPoint=[],un=0,ys=0,dataT=[],button_stop=!1,debug=!1;const max_seconds=1500;let e_start={},e_stop={},_string="",iteration=0;function Init(){e_start&&e_start.style&&(e_start.style.opacity=1),e_stop&&e_stop.style&&(e_stop.style.opacity=0),iteration=0,dataY=[1,2,3,4,5,6,7,8,9,10],dataX=[0,100],un=Math.round((Math.max(...dataX)-Math.min(...dataX))/10),un=10*Math.round(un/10),ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram()}async function wrapper(){await waitInterval(meter,999)}function getMinMaxUn(t){let a=0,e=0,n=[];if(t.length>=1)if(Array.isArray(t[0])){let n=t.map((t=>Math.max.apply(null,t)));e=Math.max(...n);let l=t.map((t=>Math.min.apply(null,t)));a=Math.min(...l)}else e=Math.max(...t),a=Math.min(...t);a==e&&(e-a>10?(a=.999*t[0],e=1.001*t[0]):(a=t[0]-10,e=t[0]+10));let l=Math.ceil((e-a)/10);return e-a>100?(e=10*Math.ceil(e/10),a=10*Math.ceil(a/10),l=10*Math.ceil(l/10)):e-a>10?(e=Math.ceil(1*e)/1,a=Math.ceil(1*a)/1,l=Math.ceil(1*l)/1):e-a>1?(l=Math.ceil(10*(e-a))/10,e=Math.ceil(10*e)/10,a=Math.ceil(10*a)/10):e-a>0&&(l=Math.ceil(100*(e-a))/100,e=Math.ceil(100*e)/100,a=Math.ceil(100*a)/100),n.push(a),n.push(e),n.push(l),n}function drawLine(){if(0!=dataX.length){let t=getMinMaxUn([dataX,datal1,datal2,datal3]);min=t[0],max=t[1],un=t[2],ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.data(),chart.draw(),chart.pointes()}return!0}function run(){button_stop=!1,""!=(ip=document.getElementById("IP").value)&&(Init(),e_start&&(e_start.style.opacity=0),e_stop&&(e_stop.style.opacity=1),dataY=[],dataX=[],datal1=[],datal2=[],datal3=[],dataT=[],dataGas=[],iteration=1,wrapper())}function stop(){button_stop=!button_stop,e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0)}async function meter(t){iteration=t;let a="http://"+ip+"/api/v1/data",e=await fetch(a);if(e.ok){let a=await e.json();document.getElementById("WifiSSID").innerHTML=a.wifi_ssid,document.getElementById("WifiStrength").innerHTML=a.wifi_strength,document.getElementById("MM").innerHTML=a.meter_model,document.getElementById("SV").innerHTML=a.smr_version,document.getElementById("P1").innerHTML=a.active_power_l1_w,a.active_power_l2_w?document.getElementById("P2").innerHTML=a.active_power_l2_w:document.getElementById("P2").innerHTML="",a.active_power_l3_w?document.getElementById("P3").innerHTML=a.active_power_l3_w:document.getElementById("P3").innerHTML="",document.getElementById("PT").innerHTML=a.active_power_w,dataX.push(a.active_power_w),datal1.push(a.active_power_l1_w),datal2.push(a.active_power_l2_w),datal3.push(a.active_power_l3_w),dataY.push(t);let n=delta_calc(dataX);document.getElementById("PTd3").innerHTML=n[0],document.getElementById("PTd2").innerHTML=n[1],document.getElementById("PTd1").innerHTML=n[2];let l=delta_calc(datal1);document.getElementById("P1d3").innerHTML=l[0],document.getElementById("P1d2").innerHTML=l[1],document.getElementById("P1d1").innerHTML=l[2];let i=delta_calc(datal2);document.getElementById("P2d3").innerHTML=i[0],document.getElementById("P2d2").innerHTML=i[1],document.getElementById("P2d1").innerHTML=i[2];let d=delta_calc(datal3);if(document.getElementById("P3d3").innerHTML=d[0],document.getElementById("P3d2").innerHTML=d[1],document.getElementById("P3d1").innerHTML=d[2],Ctx.clearRect(0,0,w,h),drawLine(),document.getElementById("ET1").innerHTML=a.total_power_export_t1_kwh,document.getElementById("ET2").innerHTML=a.total_power_export_t2_kwh,document.getElementById("IT1").innerHTML=a.total_power_import_t1_kwh,document.getElementById("IT2").innerHTML=a.total_power_import_t2_kwh,a.gas_timestamp){let t=a.gas_timestamp.toString(),e=t.substring(6,8),n=t.substring(8,10),l=t.substring(10,12),i=e+":"+n+":"+l;i=i+"/"+(t.substring(4,6)+"-"+t.substring(2,4)+"-"+t.substring(0,2));let d=Number(l)+Number(60*n)+Number(3600*e);if(0!=dataGasPoint.length){if(dataGasPoint[dataGasPoint.length-1][2]!=d||1==debug){if(_string=_string+i+" : "+a.total_gas_m3,dataGasPoint.push([i,a.total_gas_m3,d]),dataGasPoint.length>1){let t=Math.floor(1e3*(100*dataGasPoint[dataGasPoint.length-1][1]-100*dataGasPoint[dataGasPoint.length-2][1]))/100,a=(dataGasPoint[dataGasPoint.length-1][2]-dataGasPoint[dataGasPoint.length-2][2])/60;if(_string=_string+" Delta:"+t+" liter/"+Math.floor(10*a)/10+"min. ",0!=a){let e=Math.round(100*t/a)/100;_string=_string+"Flow:"+e+" l/min"}}_string+="<br>"}dataGas.push([i,a.total_gas_m3,d])}else dataGas.push([i,a.total_gas_m3,d]),dataGasPoint.push([i,a.total_gas_m3,d]),_string=i+" : "+a.total_gas_m3+"<br>";document.getElementById("TimeGasM3").innerHTML=_string}a.active_liter_lpm?(document.getElementById("AL").innerHTML=a.active_liter_lpm,document.getElementById("TL").innerHTML=a.total_liter_m3):document.getElementById("AL").innerHTML=document.getElementById("TL").innerHTML="";let o=1500==t||button_stop;return o&&stop(),o}alert("HTTP-Error: "+e.status)}async function waitInterval(t,a){return new Promise((e=>{const n=setInterval((async()=>{if(await t(iteration,n))return e(),clearInterval(n),!0;iteration++}),a)}))}function delta_calc(t){let a=[];return t.length>3?a.push(t[t.length-1]-t[t.length-4]):a.push(0),t.length>2?a.push(t[t.length-1]-t[t.length-3]):a.push(0),t.length>1?a.push(t[t.length-1]-t[t.length-2]):a.push(0),a}window.onload=function(){e_start=document.getElementById("Start"),e_stop=document.getElementById("Stop"),e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0),c=document.querySelector("canvas[le]"),h=c.height,w=c.width,Ctx=c.getContext("2d"),c.onmousemove=function(t){$("draw-canvas-data-set").style.opacity="0";for(let a of dataT)for(const[e,n]of Object.entries(a)){let a=n.split(","),e=t.layerX-10,l=t.layerY-c.height+25,i=a[1],d=a[0];range(i-10,Math.floor(i)+10).includes(e),range(d-10,Math.floor(d)+10).includes(l),range(i-10,Math.floor(i)+10).includes(e)&&range(d-10,Math.floor(d)+10).includes(l)&&($("draw-canvas-data-set").innerHTML=a[3]+":"+a[2],$("draw-canvas-data-set").style.opacity="1",$("draw-canvas-data-set").style.left=t.clientX+"px",$("draw-canvas-data-set").style.top=t.clientY+"px"),e-=1,i-=1}},Init(),document.getElementById("IP").value="192.168.2.45"};var chart={ctx:{},setCtx:function(t){ctx=t},setStrokeStyle:function(t){ctx.strokeStyle=t},digram:function(){for(y=60,x=1,ctx.strokeStyle="#a7a7a7";y<w;)ctx.beginPath(),ctx.moveTo(y,0),ctx.lineTo(y,h-30),ctx.stroke(),y+=30;for(;x<h-30;)ctx.beginPath(),ctx.moveTo(60,x),ctx.lineTo(w,x),ctx.stroke(),x+=30},chartLine:function(){ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(60,0),ctx.lineTo(60,h-30),ctx.stroke(),ctx.beginPath(),ctx.moveTo(w,h-30),ctx.lineTo(60,h-30),ctx.stroke()},draw:function(){for(data of(ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,dataX)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#00FF00"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal1)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#d6d610"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal2)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#A020F0"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal3)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=30,y+=ys}ctx.stroke(),ctx.restore()},pointes:function(){for(data of(ctx.fillStyle="#0b95d3",y=60,height=h-30,line=30,start=0,dataX))this.points(data,dataX,"Tot.");for(data of(ctx.fillStyle="#00FF00",y=60,height=h-30,line=30,start=0,datal1))this.points(data,datal1,"l1");for(data of(ctx.fillStyle="#d6d610",y=60,height=h-30,line=30,start=0,datal2))this.points(data,datal2,"l2");for(data of(ctx.fillStyle="#A020F0",y=60,height=h-30,line=30,start=0,datal3))this.points(data,datal3,"l3");ctx.fillStyle="#00000F",ctx.stroke()},points:function(t,a,e){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>t;)max-=1,test+=line/un;chart.circle(y,test),dataT.push({d:Math.round(test)+","+Math.round(y)+","+Math.round(t)+","+e}),x=0,y+=ys},data:function(){y=60,x=30;let t=[dataX,datal1,datal2,datal3].map((t=>Math.max.apply(null,t)));for(ydata of(n=Math.max(...t),n=10*Math.ceil(n/10),dataY))ctx.font="12px Arial",dataY.length>300?(ctx.fillText(60*ydata,y+60*ys-ys,h-10),y+=60*ys):dataY.length>140?(ctx.fillText(20*ydata,y+20*ys-ys,h-10),y+=20*ys):dataY.length>50?(ctx.fillText(10*ydata,y+10*ys-ys,h-10),y+=10*ys):dataY.length>20?(ctx.fillText(5*ydata,y+5*ys-ys,h-10),y+=5*ys):dataY.length>10?(ctx.fillText(2*ydata,y+2*ys-ys,h-10),y+=2*ys):(ctx.fillText(ydata,y,h-10),y+=ys);for(;x<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,x+5),n-=un,x+=30},circle:function(t,a){ctx.beginPath(),ctx.arc(t,a,4,0,2*Math.PI),ctx.fill()}};function range(t,a){return[...Array(a+1).keys()].filter((e=>a>=e&&t<=e))}function $(t){return document.querySelector(t)}