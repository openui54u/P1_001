var ip;let c={},h=0,w=0,Ctx={},CtxG={},dataY=[],dataX=[],datal1=[],datal2=[],datal3=[],dataGas=[],un=0,ys=0,dataT=[],button_stop=!1;const max_seconds=1500;let e_start={},e_stop={},_string="",iteration=0;function Init(){e_start&&e_start.style&&(e_start.style.opacity=1),e_stop&&e_stop.style&&(e_stop.style.opacity=0),iteration=0,dataY=[1,2,3,4,5,6,7,8,9,10],dataX=[0,100],un=Math.round((Math.max(...dataX)-Math.min(...dataX))/10),un=10*Math.round(un/10),ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram()}async function wrapper(){await waitInterval(meter,999)}function getMinMaxUn(t){let e=0,a=0,n=[];if(t.length>=1)if(Array.isArray(t[0])){let n=t.map((t=>Math.max.apply(null,t)));a=Math.max(...n);let l=t.map((t=>Math.min.apply(null,t)));e=Math.min(...l)}else a=Math.max(...t),e=Math.min(...t);e==a&&(a-e>10?(e=.999*t[0],a=1.001*t[0]):(e=t[0]-10,a=t[0]+10));let l=Math.ceil((a-e)/10);return a-e>100?(a=10*Math.ceil(a/10),e=10*Math.ceil(e/10),l=10*Math.ceil(l/10)):a-e>10?(a=Math.ceil(1*a)/1,e=Math.ceil(1*e)/1,l=Math.ceil(1*l)/1):a-e>1?(l=Math.ceil(10*(a-e))/10,a=Math.ceil(10*a)/10,e=Math.ceil(10*e)/10):a-e>0&&(l=Math.ceil(100*(a-e))/100,a=Math.ceil(100*a)/100,e=Math.ceil(100*e)/100),n.push(e),n.push(a),n.push(l),n}function drawLine(){if(0!=dataX.length){let t=getMinMaxUn([dataX,datal1,datal2,datal3]);min=t[0],max=t[1],un=t[2],ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.data(),chart.draw(),chart.pointes()}return!0}function run(){button_stop=!1,""!=(ip=document.getElementById("IP").value)&&(Init(),e_start&&(e_start.style.opacity=0),e_stop&&(e_stop.style.opacity=1),dataY=[],dataX=[],datal1=[],datal2=[],datal3=[],dataT=[],dataGas=[],iteration=1,wrapper())}function stop(){button_stop=!button_stop,e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0)}async function meter(t){iteration=t;let e="http://"+ip+"/api/v1/data",a=await fetch(e);if(a.ok){let e=await a.json();document.getElementById("WifiSSID").innerHTML=e.wifi_ssid,document.getElementById("WifiStrength").innerHTML=e.wifi_strength,document.getElementById("MM").innerHTML=e.meter_model,document.getElementById("SV").innerHTML=e.smr_version,document.getElementById("P1").innerHTML=e.active_power_l1_w,e.active_power_l2_w?document.getElementById("P2").innerHTML=e.active_power_l2_w:document.getElementById("P2").innerHTML="",e.active_power_l3_w?document.getElementById("P3").innerHTML=e.active_power_l3_w:document.getElementById("P3").innerHTML="",document.getElementById("PT").innerHTML=e.active_power_w,dataX.push(e.active_power_w),datal1.push(e.active_power_l1_w),datal2.push(e.active_power_l2_w),datal3.push(e.active_power_l3_w),dataY.push(t);let n=delta_calc(dataX);document.getElementById("PTd3").innerHTML=n[0],document.getElementById("PTd2").innerHTML=n[1],document.getElementById("PTd1").innerHTML=n[2];let l=delta_calc(datal1);document.getElementById("P1d3").innerHTML=l[0],document.getElementById("P1d2").innerHTML=l[1],document.getElementById("P1d1").innerHTML=l[2];let i=delta_calc(datal2);document.getElementById("P2d3").innerHTML=i[0],document.getElementById("P2d2").innerHTML=i[1],document.getElementById("P2d1").innerHTML=i[2];let d=delta_calc(datal3);if(document.getElementById("P3d3").innerHTML=d[0],document.getElementById("P3d2").innerHTML=d[1],document.getElementById("P3d1").innerHTML=d[2],Ctx.clearRect(0,0,w,h),drawLine(),document.getElementById("ET1").innerHTML=e.total_power_export_t1_kwh,document.getElementById("ET2").innerHTML=e.total_power_export_t2_kwh,document.getElementById("IT1").innerHTML=e.total_power_import_t1_kwh,document.getElementById("IT2").innerHTML=e.total_power_import_t2_kwh,e.gas_timestamp){let t=e.gas_timestamp.toString(),a=t.substring(6,8)+":"+t.substring(8,10)+":"+t.substring(10,12)+"  /  "+t.substring(4,6)+"-"+t.substring(2,4)+"-"+t.substring(0,2);0!=dataGas.length?(dataGas[dataGas.length-1][0]!=a&&(_string=_string+a+" : "+e.total_gas_m3+"<br>"),dataGas.push([a,e.total_gas_m3])):(dataGas.push([a,e.total_gas_m3]),_string=a+" : "+e.total_gas_m3+"<br>"),document.getElementById("TimeGasM3").innerHTML=_string}e.active_liter_lpm?(document.getElementById("AL").innerHTML=e.active_liter_lpm,document.getElementById("TL").innerHTML=e.total_liter_m3):document.getElementById("AL").innerHTML=document.getElementById("TL").innerHTML="";let o=1500==t||button_stop;return o&&stop(),o}alert("HTTP-Error: "+a.status)}async function waitInterval(t,e){return new Promise((a=>{const n=setInterval((async()=>{if(await t(iteration,n))return a(),clearInterval(n),!0;iteration++}),e)}))}function delta_calc(t){let e=[];return t.length>3?e.push(t[t.length-1]-t[t.length-4]):e.push(0),t.length>2?e.push(t[t.length-1]-t[t.length-3]):e.push(0),t.length>1?e.push(t[t.length-1]-t[t.length-2]):e.push(0),e}window.onload=function(){e_start=document.getElementById("Start"),e_stop=document.getElementById("Stop"),e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0),c=document.querySelector("canvas[le]"),h=c.height,w=c.width,Ctx=c.getContext("2d"),c.onmousemove=function(t){$("draw-canvas-data-set").style.opacity="0";for(let e of dataT)for(const[a,n]of Object.entries(e)){let e=n.split(","),a=t.layerX-10,l=t.layerY-c.height+25,i=e[1],d=e[0];range(i-10,Math.floor(i)+10).includes(a),range(d-10,Math.floor(d)+10).includes(l),range(i-10,Math.floor(i)+10).includes(a)&&range(d-10,Math.floor(d)+10).includes(l)&&($("draw-canvas-data-set").innerHTML=e[3]+":"+e[2],$("draw-canvas-data-set").style.opacity="1",$("draw-canvas-data-set").style.left=t.clientX+"px",$("draw-canvas-data-set").style.top=t.clientY+"px"),a-=1,i-=1}},Init(),document.getElementById("IP").value="192.168.2.45"};var chart={ctx:{},setCtx:function(t){ctx=t},setStrokeStyle:function(t){ctx.strokeStyle=t},digram:function(){for(y=60,x=1,ctx.strokeStyle="#a7a7a7";y<w;)ctx.beginPath(),ctx.moveTo(y,0),ctx.lineTo(y,h-30),ctx.stroke(),y+=30;for(;x<h-30;)ctx.beginPath(),ctx.moveTo(60,x),ctx.lineTo(w,x),ctx.stroke(),x+=30},chartLine:function(){ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(60,0),ctx.lineTo(60,h-30),ctx.stroke(),ctx.beginPath(),ctx.moveTo(w,h-30),ctx.lineTo(60,h-30),ctx.stroke()},draw:function(){for(data of(ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,dataX)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#00FF00"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal1)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#d6d610"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal2)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=0,y+=ys}for(data of(ctx.stroke(),chart.setStrokeStyle("#A020F0"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal3)){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>data;)max-=1,test+=line/un;ctx.lineTo(y,test),x=30,y+=ys}ctx.stroke(),ctx.restore()},pointes:function(){for(data of(ctx.fillStyle="#0b95d3",y=60,height=h-30,line=30,start=0,dataX))this.points(data,dataX,"Tot.");for(data of(ctx.fillStyle="#00FF00",y=60,height=h-30,line=30,start=0,datal1))this.points(data,datal1,"l1");for(data of(ctx.fillStyle="#d6d610",y=60,height=h-30,line=30,start=0,datal2))this.points(data,datal2,"l2");for(data of(ctx.fillStyle="#A020F0",y=60,height=h-30,line=30,start=0,datal3))this.points(data,datal3,"l3");ctx.fillStyle="#00000F",ctx.stroke()},points:function(t,e,a){for(max=getMinMaxUn([dataX,datal1,datal2,datal3])[1],test=30;max>t;)max-=1,test+=line/un;chart.circle(y,test),dataT.push({d:Math.round(test)+","+Math.round(y)+","+Math.round(t)+","+a}),x=0,y+=ys},data:function(){y=60,x=30;let t=[dataX,datal1,datal2,datal3].map((t=>Math.max.apply(null,t)));for(ydata of(n=Math.max(...t),n=10*Math.ceil(n/10),dataY))ctx.font="12px Arial",dataY.length>300?(ctx.fillText(60*ydata,y+60*ys-ys,h-10),y+=60*ys):dataY.length>140?(ctx.fillText(20*ydata,y+20*ys-ys,h-10),y+=20*ys):dataY.length>50?(ctx.fillText(10*ydata,y+10*ys-ys,h-10),y+=10*ys):dataY.length>20?(ctx.fillText(5*ydata,y+5*ys-ys,h-10),y+=5*ys):dataY.length>10?(ctx.fillText(2*ydata,y+2*ys-ys,h-10),y+=2*ys):(ctx.fillText(ydata,y,h-10),y+=ys);for(;x<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,x+5),n-=un,x+=30},circle:function(t,e){ctx.beginPath(),ctx.arc(t,e,4,0,2*Math.PI),ctx.fill()}};function range(t,e){return[...Array(e+1).keys()].filter((a=>e>=a&&t<=a))}function $(t){return document.querySelector(t)}