function Init(){e_start&&e_start.style&&(e_start.style.opacity=1),e_stop&&e_stop.style&&(e_stop.style.opacity=0),iteration=0,dataY=[1,2,3,4,5,6,7,8,9,10],dataX=[0,100],un=Math.round((Math.max(...dataX)-Math.min(...dataX))/10),ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.setCtx(CtxG),chart.chartLine(),chart.digram()}async function wrapper(){console.log("start"),await waitInterval(meter,999),console.log(iteration),console.log("finish")}function getMinMaxUn(t){min=0,max=0;let a=[];if(t.length>=1)if(Array.isArray(t[0])){let a=t.map(t=>Math.max.apply(null,t));max=Math.max(...a);let e=t.map(t=>Math.min.apply(null,t));min=Math.min(...e)}else max=Math.max(...t),min=Math.min(...t);min==max&&(max-min>10?(min=.999*t[0],max=1.001*t[0]):(min=t[0]-10,max=t[0]+10));let e=Math.ceil((max-min)/10);return max-min>100?(max=10*Math.ceil(max/10),min=10*Math.ceil(min/10),e=10*Math.ceil(e/10)):max-min>10?(max=Math.ceil(1*max)/1,min=Math.ceil(1*min)/1,e=Math.ceil(10*e)/10):max-min>1?(e=Math.ceil(10*(max-min))/10,max=Math.ceil(10*max)/10,min=Math.ceil(10*min)/10):max-min>0&&(e=Math.ceil(10*(max-min))/10,max=Math.ceil(100*max)/100,min=Math.ceil(100*min)/100),a.push(min),a.push(max),a.push(e),a}function drawLine(){if(0!=dataX.length){let t=[dataX,datal1,datal2,datal3],a=getMinMaxUn(t);min=a[0],max=a[1],un=a[2],ys=(w-80)/dataY.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.data(),chart.draw(),chart.pointes()}if(0!=dataGasPoint.length){let t=[];for(datagas of dataGasPoint)t.push(datagas[5]);MMU=getMinMaxUn(t),min=MMU[0],max=MMU[1],un=MMU[2],ys=(w-80)/dataYG.length,chart.setCtx(CtxG),chart.chartLine(),chart.digram(),chart.dataGas(),chart.drawG(),chart.pointesGas()}return!0}function run(){button_stop=!1,ip=document.getElementById("IP").value,""!=ip?(Init(),e_start&&(e_start.style.opacity=0),e_stop&&(e_stop.style.opacity=1),dataY=[],dataYG=[],dataX=[],datal1=[],datal2=[],datal3=[],dataT=[],dataGas=[],dataGasPoint=[],iteration=1,wrapper()):(dataY=[1,2,3,4,5,6,7,8,9,10],dataYG=[1,2,3,4,5,6,7,8,9,10],dataX=[1e3,10010,1001,980,1023,899,455,1200,300,10],datal1=[151,242,353,264,115,36,645,374,493,2],datal2=[12,14,15,33,22,44,77,22,33,34],datal3=[34,866,333,700,600,345,333,1111,233,1],dataGas=[["21:10:06/22-11-22",3037.961,76206],["21:10:06/22-11-22",3037.961,76206],["21:10:06/22-11-22",3037.961,76206],["21:15:05/22-11-22",3038.991,76505],["21:15:05/22-11-22",3038.991,76505],["21:15:05/22-11-22",3038.991,76505],["21:20:05/22-11-22",3039.991,76505],["21:20:05/22-11-22",3039.991,76505]],dataGasPoint=[["18:10:00/22-11-22",2000.101,75005,2,5,.4],["18:10:00/22-11-22",2000.108,75305,125,5,25],["18:10:00/22-11-22",2000.15,75605,100,5,20],["18:10:00/22-11-22",2000.2,75905,0,5,0],["18:10:00/22-11-22",2000.202,76205,28,5,15],["18:10:00/22-11-22",2000.205,76505,255,5,50],["18:10:00/22-11-22",2001.206,76805,25,5,5],["18:10:00/22-11-22",2001.209,77105,133,5,25]],iteration=1,Ctx.clearRect(0,0,w,h),CtxG.clearRect(0,0,wg,hg),drawLine())}function stop(){button_stop=!button_stop,e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0)}async function meter(t){iteration=t;let a="http://"+ip+"/api/v1/data",e=await fetch(a);if(e.ok){let a=await e.json();if(dataX.push(a.active_power_w),datal1.push(a.active_power_l1_w),datal2.push(a.active_power_l2_w),datal3.push(a.active_power_l3_w),dataY.push(t),document.getElementById("WifiSSID").innerHTML=a.wifi_ssid,document.getElementById("WifiStrength").innerHTML=a.wifi_strength,document.getElementById("MM").innerHTML=a.meter_model,document.getElementById("SV").innerHTML=a.smr_version,writeNumbers_E(a),Ctx.clearRect(0,0,w,h),CtxG.clearRect(0,0,wg,hg),drawLine(),a.gas_timestamp){let e=a.gas_timestamp.toString(),n=e.substring(6,8),i=e.substring(8,10),l=e.substring(10,12),o=e.substring(4,6),s=e.substring(2,4),d=e.substring(0,2),r=n+":"+i+":"+l,c=o+"-"+s+"-"+d;r=r+"/"+c;let y=Number(l)+Number(60*i)+Number(3600*n),h=0,m=0,x=0;0!=dataGasPoint.length?(dataGasPoint[dataGasPoint.length-1][2]==y&&1!=debug||(debug&&console.log(n,i,l,r,y),_string=_string+r+" : "+a.total_gas_m3,dataGasPoint.length>0&&(h=Math.floor(1e3*(100*a.total_gas_m3-100*dataGasPoint[dataGasPoint.length-1][1]))/100,m=(y-dataGasPoint[dataGasPoint.length-1][2])/60,_string=_string+" Delta:"+h+" liter/"+Math.floor(10*m)/10+"min. ",0!=m&&(x=Math.round(100*h/m)/100,_string=_string+"Flow:"+x+" l/min")),_string+="<br>",dataGasPoint.push([r,a.total_gas_m3,y,h,m,x]),dataYG.push(t)),dataGas.push([r,a.total_gas_m3,y])):(dataGas.push([r,a.total_gas_m3,y]),dataGasPoint.push([r,a.total_gas_m3,y,null,null,null]),dataYG.push(t),_string=r+" : "+a.total_gas_m3+"<br>"),document.getElementById("TimeGasM3").innerHTML=_string}a.active_liter_lpm?(document.getElementById("AL").innerHTML=a.active_liter_lpm,document.getElementById("TL").innerHTML=a.total_liter_m3):document.getElementById("AL").innerHTML=document.getElementById("TL").innerHTML="";let n=t==max_seconds||button_stop;return n&&stop(),n}alert("HTTP-Error: "+e.status)}function writeNumbers_E(t){document.getElementById("P1").innerHTML=t.active_power_l1_w,t.active_power_l2_w?document.getElementById("P2").innerHTML=t.active_power_l2_w:document.getElementById("P2").innerHTML="",t.active_power_l3_w?document.getElementById("P3").innerHTML=t.active_power_l3_w:document.getElementById("P3").innerHTML="",document.getElementById("PT").innerHTML=t.active_power_w;let a=delta_calc(dataX);document.getElementById("PTd3").innerHTML=a[0],document.getElementById("PTd2").innerHTML=a[1],document.getElementById("PTd1").innerHTML=a[2];let e=delta_calc(datal1);document.getElementById("P1d3").innerHTML=e[0],document.getElementById("P1d2").innerHTML=e[1],document.getElementById("P1d1").innerHTML=e[2];let n=delta_calc(datal2);document.getElementById("P2d3").innerHTML=n[0],document.getElementById("P2d2").innerHTML=n[1],document.getElementById("P2d1").innerHTML=n[2];let i=delta_calc(datal3);document.getElementById("P3d3").innerHTML=i[0],document.getElementById("P3d2").innerHTML=i[1],document.getElementById("P3d1").innerHTML=i[2],document.getElementById("ET1").innerHTML=t.total_power_export_t1_kwh,document.getElementById("ET2").innerHTML=t.total_power_export_t2_kwh,document.getElementById("IT1").innerHTML=t.total_power_import_t1_kwh,document.getElementById("IT2").innerHTML=t.total_power_import_t2_kwh}async function waitInterval(t,a){return new Promise(e=>{const n=setInterval(async()=>{if(await t(iteration,n))return e(),clearInterval(n),!0;iteration++},a)})}function delta_calc(t){let a=[];return t.length>3?a.push(t[t.length-1]-t[t.length-4]):a.push(0),t.length>2?a.push(t[t.length-1]-t[t.length-3]):a.push(0),t.length>1?a.push(t[t.length-1]-t[t.length-2]):a.push(0),a}function $(t){return document.querySelector(t)}var ip;let c={},h=0,w=0,Ctx={},CtxG={},dataY=[],dataYG=[],dataX=[],datal1=[],datal2=[],datal3=[],dataGas=[],dataGasPoint=[],un=0,ys=0,dataT=[],button_stop=!1,tabE={},tabG={},debug=!1;var MMU;const max_seconds=1500;let e_start={},e_stop={},_string="",min=0,max=0,iteration=0;window.onload=function(){function t(t){let a=t.currentTarget.attributes[1].nodeValue;t.currentTarget.attributes[4].nodeValue;for(let e of dataT)for(const[n,i]of Object.entries(e)){let e=i.split(","),n=Number(t.offsetX),l=Number(t.offsetY),o=Number(e[1]),s=Number(e[0]),d=Math.floor(Number(e[4])/3);d<10&&(d=10),n>o-d&&n<o+d&&l>s-d&&l<s+d&&("E"==a&&"Gas"!=e[3]?(tabE.innerHTML=e[3]+":"+e[2],tabE.style.opacity="1",tabE.style.left=t.layerX+"px",tabE.style.top=t.layerY+"px"):"G"==a&&"Gas"==e[3]&&(tabG.innerHTML=e[3]+":"+e[2],tabG.style.opacity="1",tabG.style.left=t.layerX+"px",tabG.style.top=t.layerY+"px")),n-=1,o-=1}}e_start=document.getElementById("Start"),e_stop=document.getElementById("Stop"),e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0),c=document.querySelector("canvas[le]"),cg=document.querySelector("canvas[lg]"),tabE=document.querySelector("draw-canvas-data-set"),tabG=document.querySelector("draw-canvas-data-setG"),h=c.height,w=c.width,hg=cg.height,wg=cg.width,Ctx=c.getContext("2d"),CtxG=cg.getContext("2d"),cg.onmousemove=function(a){document.getElementById("G").focus(),tabE.style.opacity="0",tabG.style.opacity="0",t(a)},c.onmousemove=function(a){tabE.style.opacity="0",tabG.style.opacity="0",document.getElementById("E").focus(),t(a)},Init(),document.getElementById("IP").value="192.168.2.45"};var chart={ctx:{},setCtx:function(t){ctx=t},setStrokeStyle:function(t){ctx.strokeStyle=t},digram:function(){for(y=60,x=1,ctx.strokeStyle="#a7a7a7";y<w;)ctx.beginPath(),ctx.moveTo(y,0),ctx.lineTo(y,h-30),ctx.stroke(),y+=30;for(;x<h-30;)ctx.beginPath(),ctx.moveTo(60,x),ctx.lineTo(w,x),ctx.stroke(),x+=30},chartLine:function(){ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(60,0),ctx.lineTo(60,h-30),ctx.stroke(),ctx.beginPath(),ctx.moveTo(w,h-30),ctx.lineTo(60,h-30),ctx.stroke()},draw:function(){ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=4,ctx.beginPath(),y=60,height=h-30,line=30,start=0;let t=[dataX,datal1,datal2,datal3];for(data of(MMU=getMinMaxUn(t),dataX))test=30,test+=(10-(data-MMU[0])/MMU[2])*line,ctx.lineTo(y,test),y+=ys;for(data of(ctx.stroke(),chart.setStrokeStyle("#00FF00"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal1))test=30,test+=(10-(data-MMU[0])/MMU[2])*line,ctx.lineTo(y,test),y+=ys;for(data of(ctx.stroke(),chart.setStrokeStyle("#d6d610"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal2))test=30,test+=(10-(data-MMU[0])/MMU[2])*line,ctx.lineTo(y,test),y+=ys;for(data of(ctx.stroke(),chart.setStrokeStyle("#A020F0"),ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30,start=0,datal3))test=30,test+=(10-(data-MMU[0])/MMU[2])*line,ctx.lineTo(y,test),y+=ys;ctx.stroke(),ctx.restore()},drawG:function(){ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=3,ctx.beginPath(),y=60,height=h-30,line=30;let t=[];for(datagas of dataGasPoint)t.push(datagas[5]);const a=getMinMaxUn(t);for(data of dataGasPoint)test=30,test+=(10-(data[5]-a[0])/a[2])*line,ctx.lineTo(y,test),y+=ys;ctx.stroke(),ctx.restore()},pointes:function(){let t=[dataX,datal1,datal2,datal3];getMinMaxUn(t);for(data of(ctx.fillStyle="#0b95d3",y=60,height=h-30,line=30,dataX))this.points(data,dataX,"Tot.");for(data of(ctx.fillStyle="#00FF00",y=60,height=h-30,line=30,start=30,datal1))this.points(data,datal1,"l1");for(data of(ctx.fillStyle="#d6d610",y=60,height=h-30,line=30,start=30,datal2))this.points(data,datal2,"l2");for(data of(ctx.fillStyle="#A020F0",y=60,height=h-30,line=30,start=30,datal3))this.points(data,datal3,"l3");ctx.fillStyle="#00000F",ctx.stroke()},points:function(t,a,e){test=30,test+=(10-(t-MMU[0])/MMU[2])*line,chart.circle(y,test),dataT.push({d:Math.round(test)+","+Math.round(y)+","+Math.round(t)+","+e+","+MMU}),y+=ys},pointesGas:function(){ctx.fillStyle="#0b95d3",y=60,height=h-30,line=30,start=30;let t=[];for(datagas of dataGasPoint)t.push(datagas[5]);for(data of(MMU=getMinMaxUn(t),dataGasPoint))this.pointsGas(data[5],dataGasPoint,"Gas");ctx.fillStyle="#00000F",ctx.stroke()},pointsGas:function(t,a,e){test=30,test+=(10-(t-MMU[0])/MMU[2])*line,chart.circle(y,test),dataT.push({d:Math.round(test)+","+Math.round(y)+","+Math.round(t)+","+e+","+MMU}),y+=ys},data:function(){y=60,x=30;let t=[dataX,datal1,datal2,datal3];t.map(t=>Math.max.apply(null,t));for(ydata of(n=max,dataY))ctx.font="12px Arial",dataY.length>300?(ctx.fillText(60*ydata,y+60*ys-ys,h-10),y+=60*ys):dataY.length>140?(ctx.fillText(20*ydata,y+20*ys-ys,h-10),y+=20*ys):dataY.length>50?(ctx.fillText(10*ydata,y+10*ys-ys,h-10),y+=10*ys):dataY.length>20?(ctx.fillText(5*ydata,y+5*ys-ys,h-10),y+=5*ys):dataY.length>10?(ctx.fillText(2*ydata,y+2*ys-ys,h-10),y+=2*ys):(ctx.fillText(ydata,y,h-10),y+=ys);for(;x<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,x+5),n-=un,x+=30},dataGas:function(){for(ydata of(y=60,x=30,n=max,dataYG))ctx.font="12px Arial",dataYG.length>300?(ctx.fillText(60*ydata,y+60*ys-ys,h-10),y+=60*ys):dataYG.length>140?(ctx.fillText(20*ydata,y+20*ys-ys,h-10),y+=20*ys):dataYG.length>50?(ctx.fillText(10*ydata,y+10*ys-ys,h-10),y+=10*ys):dataYG.length>20?(ctx.fillText(5*ydata,y+5*ys-ys,h-10),y+=5*ys):dataYG.length>10?(ctx.fillText(2*ydata,y+2*ys-ys,h-10),y+=2*ys):(ctx.fillText(ydata,y,h-10),y+=ys);for(;x<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,x+5),n-=un,n=Math.floor(100*n)/100,x+=30},circle:function(t,a){ctx.beginPath(),ctx.arc(t,a,4,0,2*Math.PI),ctx.fill()}};