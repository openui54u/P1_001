function Init(){e_start&&e_start.style&&(e_start.style.opacity=1),e_stop&&e_stop.style&&(e_stop.style.opacity=0),e_scan&&e_scan.style&&(e_scan.style.opacity=1),iteration=0,dataX=[1,2,3,4,5,6,7,8,9,10],dataL_Total=[0,100],un=Math.round((Math.max(...dataL_Total)-Math.min(...dataL_Total))/10),xs=(w-80)/dataX.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.setCtx(CtxG),chart.chartLine(),chart.digram()}async function wrapper(){console.log("start"),await waitInterval(meter,999),console.log(iteration),console.log("finish")}function getMinMaxUn(t){min=0,max=0;let e=[];if(zoomStatus?(_s=_tabIndeX-10,_s<0&&(_s=0),_e=_tabIndeX+10,_e>t.length-1&&(_e=t.length-1),e[0]=t[0].slice(_s,_e),e[1]=t[1].slice(_s,_e),e[2]=t[2].slice(_s,_e),e[3]=t[3].slice(_s,_e)):(_s=0,_e=t[0]?t[0].length-1:-1,e=t),e.length>=1)if(Array.isArray(e[0])){let t=e.map(t=>Math.max.apply(null,t));max=Math.max(...t);let a=e.map(t=>Math.min.apply(null,t));min=Math.min(...a)}else max=Math.max(...e),min=Math.min(...e);min==max&&(max-min>10?(min=.999*e[0],max=1.001*e[0]):(min=0,max=e[0]+10));let a=(max-min)/10;return a>=100?(max=1e3*Math.ceil(max/1e3),min=1e3*Math.floor(min/1e3),a=100*Math.ceil(a/100)):a>=10?(max=100*Math.ceil(max/100),min=100*Math.floor(min/100),a=10*Math.ceil(a/10)):a>=1?(max=10*Math.ceil(max/10),min=10*Math.floor(min/10),a=1*Math.ceil(a/1)):a>=0&&(max=Math.ceil(1*max)/1,min=Math.floor(1*min)/1,a=Math.ceil(10*a)/10),[min,max,a]}function drawLine(){if(0!=dataL_Total.length){let t=[dataL_Total,datal1,datal2,datal3];MMU=getMinMaxUn(t),min=MMU[0],max=MMU[1],un=MMU[2],xs=(w-80)/dataX.length,dataT=[],chart.setCtx(Ctx),chart.chartLine(),chart.digram(),chart.data(),chart.draw(),chart.pointes()}if(0!=dataGasPoint.length){let t=[];for(datagas of dataGasPoint)t.push(datagas[5]);MMU=getMinMaxUn(t),min=MMU[0],max=MMU[1],un=MMU[2],xs=(w-80)/dataXG.length,chart.setCtx(CtxG),chart.chartLine(),chart.digram(),chart.dataGas(),chart.drawG(),chart.pointesGas()}return!0}async function tryIP(t){let e="http://"+t+"/api/v1/data";const a=new Promise((a,n)=>{debug&&console.log(e),fetch(e).then(function(e){e.ok&&(ip=t,console.log(ip),debug&&console.log("Found, url, ip"),document.getElementById("IP").value=ip)})}),n=new Promise((t,e)=>setTimeout(e,10));try{await Promise.race([a,n])}catch(t){debug&&console.log(e,"failed")}}function scanIP(){if(ip=document.getElementById("IP").value,""!=ip&&ip.split(".")[3].includes("*")){let e=ip;for(var t=1;t<256;t++){let a=e.split(".");a[3]=t,e=a[0]+"."+a[1]+"."+a[2]+"."+a[3],debug&&console.log(e),tryIP(e)}}}function run(){button_stop=!1,ip=document.getElementById("IP").value,""==ip||ip.includes("*")?(dataX=[1,2,3,4,5,6,7,8,9,10],dataXG=[1,2,3,4,5,6,7,8,9,10],dataL_Total=[1e3,10010,1001,980,1023,899,455,1200,300,10],datal1=[151,242,353,264,115,36,645,374,493,2],datal2=[12,14,15,33,22,44,77,22,33,34],datal3=[34,866,333,700,600,345,333,1111,233,1],dataGas=[["21:10:06/22-11-22",3037.961,76206],["21:10:06/22-11-22",3037.961,76206],["21:10:06/22-11-22",3037.961,76206],["21:15:05/22-11-22",3038.991,76505],["21:15:05/22-11-22",3038.991,76505],["21:15:05/22-11-22",3038.991,76505],["21:20:05/22-11-22",3039.991,76505],["21:20:05/22-11-22",3039.991,76505]],dataGasPoint=[["18:10:00/22-11-22",2000.101,75005,2,5,.4],["18:10:00/22-11-22",2000.108,75305,125,5,25],["18:10:00/22-11-22",2000.15,75605,100,5,20],["18:10:00/22-11-22",2000.2,75905,0,5,0],["18:10:00/22-11-22",2000.202,76205,28,5,15],["18:10:00/22-11-22",2000.205,76505,255,5,50],["18:10:00/22-11-22",2001.206,76805,25,5,5],["18:10:00/22-11-22",2001.209,77105,133,5,25]],iteration=1,Ctx.clearRect(0,0,w,h),CtxG.clearRect(0,0,wg,hg),drawLine(),writeNumbers_E({active_power_w:dataL_Total[dataL_Total.length-1],active_power_l1_w:datal1[dataL_Total.length-1],active_power_l2_w:datal1[dataL_Total.length-1],active_power_l3_w:datal1[dataL_Total.length-1],total_gas_m3:dataGasPoint[dataGasPoint.length-1],total_power_export_t1_kwh:1234,total_power_export_t2_kwh:83,total_power_import_t1_kwh:987,total_power_import_t2_kwh:321})):(Init(),e_start&&(e_start.style.opacity=0),e_stop&&(e_stop.style.opacity=1),e_scan&&e_scan.style&&(e_scan.style.opacity=0),dataX=[],dataXG=[],dataL_Total=[],datal1=[],datal2=[],datal3=[],dataT=[],dataGas=[],dataGasPoint=[],iteration=1,wrapper())}function stop(){button_stop=!button_stop,e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0),e_scan&&e_scan.style&&(e_scan.style.opacity=1)}async function meter(t){iteration=t;let e="http://"+ip+"/api/v1/data",a=await fetch(e);if(a.ok){let e=await a.json();if(dataL_Total.push(e.active_power_w),datal1.push(e.active_power_l1_w),datal2.push(e.active_power_l2_w),datal3.push(e.active_power_l3_w),dataX.push(t),document.getElementById("WifiSSID").innerHTML=e.wifi_ssid,document.getElementById("WifiStrength").innerHTML=e.wifi_strength,document.getElementById("MM").innerHTML=e.meter_model,document.getElementById("SV").innerHTML=e.smr_version,writeNumbers_E(e),Ctx.clearRect(0,0,w,h),CtxG.clearRect(0,0,wg,hg),drawLine(),e.gas_timestamp){let a=e.gas_timestamp.toString(),n=a.substring(6,8),l=a.substring(8,10),o=a.substring(10,12),i=a.substring(4,6),s=a.substring(2,4),r=a.substring(0,2),c=n+":"+l+":"+o,d=i+"-"+s+"-"+r;c=c+"/"+d;let x=new Date("20"+r+"-"+s+"-"+i+"T"+n+":"+l+":"+o).getTime();debug&&console.log(new Date(x),x);let h=0,_=0,m=0;if(0!=dataGasPoint.length){if(dataGasPoint[dataGasPoint.length-1][2]!=x||1==debug){debug&&console.log(n,l,o,c,x);let a=dataGasPoint[0][1],i=1e3*(Math.floor(1e3*e.total_gas_m3)-Math.floor(1e3*a))/1e3;_string=_string+"<tr><th>"+c+"</th>",dataGasPoint.length>0&&(h=Math.floor(1e3*(1e3*e.total_gas_m3-1e3*dataGasPoint[dataGasPoint.length-1][1]))/1e3,_=(x-dataGasPoint[dataGasPoint.length-1][2])/6e4,_string=_string+"<th>"+e.total_gas_m3+"</th><th>"+i+"</th><th>"+h+"</th><th>"+Math.floor(10*_)/10+"</th>",0!=_&&(m=Math.round(100*h/_)/100,_string=_string+"<th>"+m+"</th>")),_string+="</tr>",dataGasPoint.push([c,e.total_gas_m3,x,h,_,m]),dataXG.push(t)}dataGas.push([c,e.total_gas_m3,x])}else dataGas.push([c,e.total_gas_m3,x]),dataGasPoint.push([c,e.total_gas_m3,x,null,null,null]),dataXG.push(t),_string=_string+"<tr><th>"+c+"<th>"+e.total_gas_m3+"</th></tr>";_k=object("#TimeGasM3"),_k.innerHTML=_string}e.active_liter_lpm?(document.getElementById("AL").innerHTML=e.active_liter_lpm,document.getElementById("TL").innerHTML=e.total_liter_m3):document.getElementById("AL").innerHTML=document.getElementById("TL").innerHTML="";let n=t==max_seconds||button_stop;return n&&stop(),n}alert("HTTP-Error: "+a.status)}function writeNumbers_E(t){document.getElementById("P1").innerHTML=t.active_power_l1_w,t.active_power_l2_w?document.getElementById("P2").innerHTML=t.active_power_l2_w:document.getElementById("P2").innerHTML="",t.active_power_l3_w?document.getElementById("P3").innerHTML=t.active_power_l3_w:document.getElementById("P3").innerHTML="",document.getElementById("PT").innerHTML=t.active_power_w;let e=delta_calc(dataL_Total);document.getElementById("PTd3").innerHTML=e[0],document.getElementById("PTd2").innerHTML=e[1],document.getElementById("PTd1").innerHTML=e[2];let a=delta_calc(datal1);document.getElementById("P1d3").innerHTML=a[0],document.getElementById("P1d2").innerHTML=a[1],document.getElementById("P1d1").innerHTML=a[2];let n=delta_calc(datal2);document.getElementById("P2d3").innerHTML=n[0],document.getElementById("P2d2").innerHTML=n[1],document.getElementById("P2d1").innerHTML=n[2];let l=delta_calc(datal3);document.getElementById("P3d3").innerHTML=l[0],document.getElementById("P3d2").innerHTML=l[1],document.getElementById("P3d1").innerHTML=l[2],document.getElementById("ET1").innerHTML=t.total_power_export_t1_kwh,document.getElementById("ET2").innerHTML=t.total_power_export_t2_kwh,document.getElementById("IT1").innerHTML=t.total_power_import_t1_kwh,document.getElementById("IT2").innerHTML=t.total_power_import_t2_kwh}async function waitInterval(t,e){return new Promise(a=>{const n=setInterval(async()=>{if(await t(iteration,n))return a(),clearInterval(n),!0;iteration++},e)})}function delta_calc(t){let e=[];return t.length>3?e.push(t[t.length-1]-t[t.length-4]):e.push(0),t.length>2?e.push(t[t.length-1]-t[t.length-3]):e.push(0),t.length>1?e.push(t[t.length-1]-t[t.length-2]):e.push(0),e}function $(t){return document.querySelector(t)}function object(t){return document.querySelector(t)}var ip;let c={},h=0,w=0,Ctx={},CtxG={},dataX=[],dataXG=[],dataL_Total=[],datal1=[],datal2=[],datal3=[],dataGas=[],dataGasPoint=[],un=0,xs=0,dataT=[],button_stop=!1,tabE={},tabG={};var zoomStatus=!1;let debug=!1;var MMU,_tabIndeX=0;const max_seconds=86400;let e_start={},e_stop={},e_scan={},_string="<tr><th>Time (hh:mm:ss/dd-mm-yy)</th><th>Gas (m3)</th><th>DeltaSum(liter)</th><th>Delta (liter)</th><th>min.</th><th>Flow (liter/min )</th></tr> ",min=0,max=0,_s=0,_e=0;var _k;let iteration=0;window.onload=function(){function t(t){let e=t.currentTarget.attributes[1].nodeValue;_tabIndeX=t.currentTarget.attributes[4].nodeValue,zoomStatus=!1;for(let a of dataT)for(const[n,l]of Object.entries(a)){let a=l.split(","),n=Number(t.offsetX),o=Number(t.offsetY),i=Number(a[1]),s=Number(a[0]),r=Math.floor(Number(a[4])/3);r<10&&(r=10),n>i-r&&n<i+r&&o>s-r&&o<s+r&&("E"==e&&"Gas"!=a[3]?(tabE.innerHTML=a[3]+":"+a[2],tabE.style.opacity="1",tabE.style.left=t.layerX+"px",tabE.style.top=t.layerY+"px"):"G"==e&&"Gas"==a[3]&&(tabG.innerHTML=a[3]+":"+a[2],tabG.style.opacity="1",tabG.style.left=t.layerX+"px",tabG.style.top=t.layerY+"px")),n-=1,i-=1}}e_start=document.getElementById("Start"),e_stop=document.getElementById("Stop"),e_scan=document.getElementById("Scan"),e_start&&(e_start.style.opacity=1),e_stop&&(e_stop.style.opacity=0),e_scan&&e_scan.style&&(e_scan.style.opacity=1),c=document.querySelector("canvas[le]"),cg=document.querySelector("canvas[lg]"),tabE=document.querySelector("draw-canvas-data-set"),tabG=document.querySelector("draw-canvas-data-setG"),h=c.height,w=c.width,hg=cg.height,wg=cg.width,Ctx=c.getContext("2d"),CtxG=cg.getContext("2d"),cg.onmousemove=function(e){document.getElementById("G").focus(),tabE.style.opacity="0",tabG.style.opacity="0",t(e)},c.onmousemove=function(e){tabE.style.opacity="0",tabG.style.opacity="0",document.getElementById("E").focus(),t(e)},Init(),document.getElementById("IP").value="192.168.2.*"};var chart={ctx:{},setCtx:function(t){ctx=t},setStrokeStyle:function(t){ctx.strokeStyle=t},digram:function(){for(x=60,y=1,ctx.strokeStyle="#a7a7a7";x<w;)ctx.beginPath(),ctx.moveTo(x,0),ctx.lineTo(x,h-30),ctx.stroke(),x+=30;for(;y<h-30;)ctx.beginPath(),ctx.moveTo(60,y),ctx.lineTo(w,y),ctx.stroke(),y+=30},chartLine:function(){ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(60,0),ctx.lineTo(60,h-30),ctx.stroke(),ctx.beginPath(),ctx.moveTo(w,h-30),ctx.lineTo(60,h-30),ctx.stroke()},draw:function(){for(data of(ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=4,ctx.beginPath(),x=60,line=30,start=0,dataL_Total))y=30,y+=(MMU[1]-data)/MMU[2]*line,ctx.lineTo(x,y),x+=xs;for(data of(ctx.stroke(),chart.setStrokeStyle("#00FF00"),ctx.lineWidth=3,ctx.beginPath(),x=60,line=30,start=0,datal1))y=30,y+=(MMU[1]-data)/MMU[2]*line,ctx.lineTo(x,y),x+=xs;for(data of(ctx.stroke(),chart.setStrokeStyle("#d6d610"),ctx.lineWidth=3,ctx.beginPath(),x=60,line=30,start=0,datal2))y=30,y+=(MMU[1]-data)/MMU[2]*line,ctx.lineTo(x,y),x+=xs;for(data of(ctx.stroke(),chart.setStrokeStyle("#A020F0"),ctx.lineWidth=3,ctx.beginPath(),x=60,line=30,start=0,datal3))y=30,y+=(MMU[1]-data)/MMU[2]*line,ctx.lineTo(x,y),x+=xs;ctx.stroke(),ctx.restore()},drawG:function(){ctx.save(),ctx.strokeStyle="#0b95d3",ctx.lineWidth=3,ctx.beginPath(),x=60,line=30;let t=[];for(datagas of dataGasPoint)t.push(datagas[5]);for(data of(MMU=getMinMaxUn(t),dataGasPoint))y=30,y+=(MMU[1]-data[5])/MMU[2]*line,ctx.lineTo(x,y),x+=xs;ctx.stroke(),ctx.restore()},pointes:function(){for(data of(ctx.fillStyle="#0b95d3",x=60,line=30,dataL_Total))this.points(data,dataL_Total,"Tot.");for(data of(ctx.fillStyle="#00FF00",x=60,line=30,start=30,datal1))this.points(data,datal1,"l1");for(data of(ctx.fillStyle="#d6d610",x=60,line=30,start=30,datal2))this.points(data,datal2,"l2");for(data of(ctx.fillStyle="#A020F0",x=60,line=30,start=30,datal3))this.points(data,datal3,"l3");ctx.fillStyle="#00000F",ctx.stroke()},points:function(t,e,a){y=30,y+=(MMU[1]-data)/MMU[2]*line,chart.circle(x,y),dataT.push({d:Math.round(y)+","+Math.round(x)+","+Math.round(t)+","+a+","+MMU}),x+=xs},pointesGas:function(){for(data of(ctx.fillStyle="#0b95d3",x=60,line=30,start=30,dataGasPoint))this.pointsGas(data[5],dataGasPoint,"Gas");ctx.fillStyle="#00000F",ctx.stroke()},pointsGas:function(t,e,a){y=30,y+=(MMU[1]-t)/MMU[2]*line,chart.circle(x,y),dataT.push({d:Math.round(y)+","+Math.round(x)+","+Math.round(10*t)/10+","+a+","+MMU}),x+=xs},data:function(){x=60,y=30,n=max;let t=_e-_s+1;for(let e=_s;e<_e;e++){const a=dataX[e];ctx.font="12px Arial",t>300?(ctx.fillText(60*a,x+60*xs-xs,h-10),x+=60*xs):t>140?(ctx.fillText(20*a,x+20*xs-xs,h-10),x+=20*xs):t>50?(ctx.fillText(10*a,x+10*xs-xs,h-10),x+=10*xs):t>20?(ctx.fillText(5*a,x+5*xs-xs,h-10),x+=5*xs):t>10?(ctx.fillText(2*a,x+2*xs-xs,h-10),x+=2*xs):(ctx.fillText(a,x,h-10),x+=xs)}for(;y<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,y+5),n-=un,y+=30},dataGas:function(){for(xdata of(x=60,y=30,n=max,dataXG))ctx.font="12px Arial",dataXG.length>300?(ctx.fillText(60*xdata,x+60*xs-xs,h-10),x+=60*xs):dataXG.length>140?(ctx.fillText(20*xdata,x+20*xs-xs,h-10),x+=20*xs):dataXG.length>50?(ctx.fillText(10*xdata,x+10*xs-xs,h-10),x+=10*xs):dataXG.length>20?(ctx.fillText(5*xdata,x+5*xs-xs,h-10),x+=5*xs):dataXG.length>10?(ctx.fillText(2*xdata,x+2*xs-xs,h-10),x+=2*xs):(ctx.fillText(xdata,x,h-10),x+=xs);for(;y<h-30;)ctx.font="11px Arial",ctx.fillText(n,0,y+5),n-=un,n=Math.floor(100*n)/100,y+=30},circle:function(t,e){ctx.beginPath(),ctx.arc(t,e,4,0,2*Math.PI),ctx.fill()}};